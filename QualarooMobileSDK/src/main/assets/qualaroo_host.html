<!DOCTYPE html>
<html>
    <head>
        <title>Qualaroo Host</title>
        <!-- meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"-->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no">
        <script type="text/javascript" src="qualaroo_host_js.js"></script>
    </head>

    <body>
        <!-- Qualaroo for localhost -->
        <script type="text/javascript">
            var _kiq = _kiq || [];
            var qualarooHost = new QualarooHost();
            var deferredTriggerSurveyFn;
            var qualarooScriptLoaded = false;
            var qualarooScriptLoading = false;
            var isOldVersion = false;
            var alias;

            if (false) {
              // Disable screener hiding for debugging purposes
              window.oldSetTimeout = window.setTimeout;
              window.setTimeout = function (func, delay) {
                if (delay == 0) {
                  return window.oldSetTimeout(func, delay);
                } else {
                  console.log('Ignore timer for ' + delay.toString() + 'ms');
                }
              };
            }

            function loadQualarooScriptIfNeeded(url) {
                if (!qualarooScriptLoaded && !qualarooScriptLoading) {
                    qualarooScriptLoading = true;

                    var onLoad = function() {
                        qualarooScriptLoaded = true;
                        qualarooScriptLoading = false;

                        QualarooMobile.qualarooScriptLoadSuccess(url);

                        getSurveyInfo();

                        setTimeout(function() {
                          qualarooHost.reload();
                        }, 1800000);

                        if (deferredTriggerSurveyFn) {
                            setTimeout(function() {
                                deferredTriggerSurveyFn();
                                deferredTriggerSurveyFn = null;
                            }, 50);
                        }
                    };

                    var onError = function() {
                        qualarooScriptLoaded = false;
                        qualarooScriptLoading = false;
                        QualarooMobile.qualarooScriptLoadError(url);
                    };

                    qualarooHost.loadQualarooScript(url, onLoad, onError);
                }
            }

            function triggerSurvey(surveyAlias, shouldForce) {
              alias = surveyAlias;
              if (qualarooScriptLoaded) {
                var surveyID = String(KI._info.surveyAliases[surveyAlias]);
                _kiq.push(['stopSurvey']);
                _kiq.push(['showSurvey', surveyID, shouldForce]);
              } else {
                // Let's trigger later
                deferredTriggerSurveyFn = function() {
                  triggerSurvey(surveyAlias, shouldForce);
                };
              }
            }

            function getSurveyInfo() {
              var surveysInfo = {
                surveyRequireMaps: KI._info.surveyRequireMaps,
                surveyAliases: KI._info.surveyAliases
              };
              qualarooHost.notifyGetSurveysInfo(JSON.stringify(surveysInfo));
            }

            window.addEventListener("error", function(e) {
                qualarooHost.handleGlobalErrorEvent(e);
            }, true);

            window.addEventListener("resize", function() {
                setTimeout(function() {
                    qualarooHost.reflowAnswers();
                    qualarooHost.demoScroll(alias);
                    qualarooHost.notifySurveyHeightChangedIfNeeded();
                }, 250);
            });

            _kiq.push(['eventHandler', 'show', function() {
                qualarooHost.removeBaseURL();

                setTimeout(function() {
                    if (isOldVersion) {
                        qualarooHost.loadStylesheetIfNotAlreadyLoaded("qualaroo_custom.css", function() {});
                        qualarooHost.loadStylesheetIfNotAlreadyLoaded("qualaroo_custom_4_0_3.css", function() {});
                        setTimeout(function() {
                            qualarooHost.loadThemeStylesheetBasedOnBackgroundInElement("qual_ol", function() {});
                            setTimeout(function() {
                                qualarooHost.setBaseURLToHTTPS();
                                qualarooHost.notifySurveyHeightChangedIfNeeded();
                                qualarooHost.notifySurveyShow();
                            }, 100);
                        }, 100);
                    } else {
                        qualarooHost.loadStylesheetIfNotAlreadyLoaded("qualaroo_custom.css", function() {
                            qualarooHost.loadThemeStylesheetBasedOnBackgroundInElement("qual_ol", function() {
                                qualarooHost.setBaseURLToHTTPS();
                                qualarooHost.notifySurveyShow();
                            });
                        });
                    }
                }, 0);
            }]);

            _kiq.push(['eventHandler', 'screenerReady', function() {
                qualarooHost.removeBaseURL();

                setTimeout(function() {
                    qualarooHost.forceHTTPSinBackgroundURL("qual_scrnr_logo");

                    if (isOldVersion) {
                        qualarooHost.loadStylesheetIfNotAlreadyLoaded("qualaroo_custom.css", function() {});
                        qualarooHost.loadStylesheetIfNotAlreadyLoaded("qualaroo_custom_4_0_3.css", function() {});
                        setTimeout(function() {
                            qualarooHost.loadThemeStylesheetBasedOnBackgroundInElement("qual_scrnr", function() {});
                            setTimeout(function() {
                                qualarooHost.setBaseURLToHTTPS();
                                qualarooHost.notifySurveyHeightChangedForScreenerIfNeeded();
                                qualarooHost.notifySurveyScreenerReady();
                            }, 100);
                        }, 100);
                    } else {
                        qualarooHost.loadStylesheetIfNotAlreadyLoaded("qualaroo_custom.css", function() {
                          qualarooHost.loadThemeStylesheetBasedOnBackgroundInElement("qual_scrnr", function() {
                            qualarooHost.setBaseURLToHTTPS();
                            qualarooHost.notifySurveyHeightChangedForScreenerIfNeeded();
                            qualarooHost.notifySurveyScreenerReady();
                          });
                        });
                    }
                }, 0);
            }]);

            _kiq.push(['eventHandler', 'nodeRendered', function() {
                setTimeout(function() {
                    qualarooHost.forceHTTPSinBackgroundURL("qual_ol_logo");
                    qualarooHost.addEventListenerOnCloseButton();
                    qualarooHost.reflowAnswers();
                    qualarooHost.hideLogoIfCheckIsPresent();
                    qualarooHost.notifySurveyHeightChangedIfNeeded();
                }, 0);
                qualarooHost.addOnClickItems();
            }]);

            _kiq.push(['eventHandler', 'close', function() {
                qualarooHost.notifySurveyClosed();
            }]);

            _kiq.push(['eventHandler', 'submit', function() {
                if (isOldVersion) {
                    var stuff = document.getElementById("qual_ol_stuff");
                    if (stuff) {
                        stuff.style.height = '';
                    }
                    qualarooHost.notifySurveyHeightChangedIfNeeded();
                }
            }]);
        </script>
    </body>
</html>
